# 論文レビュー支援のための前処理パイプライン 仕様書／基本設計書  
**（PDF → 構造化Markdown＋sidecar＋監査可能な段落位置）**  
Version: 0.9（ドラフト）  
Owner: （貴プロジェクト）  
Date: 2026-01-15

---

## 0. 要旨

本仕様書は、学術論文PDFを入力として、**本文の意味を極力損なわず**にAIが読解・統合レビュー（因果整理、類型化、矛盾検出、概念差分）を実行可能な形式へ変換する前処理システムを定義する。  
PDF直読はレイアウト・ノイズ・読み順不定・表抽出不確実性により一般化が困難であるため、本システムでは**PDFから「ノイズ除去済み本文（Markdown）」を復元し**、同時に**出どころ（PDFページ・座標）と結びつくsidecar（リンクラベル）**を生成する。これにより、(a) AI入力の最適化、(b) 人間による監査可能性、(c) 複数論文の統合レビューに必要な構造（文意・引用・図表・主張単位・関係）の付与を両立する。

---

## 1. 背景と設計方針

### 1.1 背景
- PDFは主として「印刷見た目の座標情報」であり、文章の意味構造（読み順、段落、脚注、図表の参照関係）を直接保持しない。
- 統合レビューで重要な「先行研究の使い方」「RQ→仮説→方法→結果→解釈の鎖」「図表の参照」「限定条件」「因果主張の主張趣旨（同定の強さ）」は、単純なテキスト抽出や要約で破壊されやすい。
- よって、**本文は可能な限り保持**し、AIに必要な構造は**リンクラベルレイヤ（sidecar）で付与**する方針が妥当。

### 1.2 設計方針（Design Principles）
1. **ロスレス志向（本文保持）**  
   要約や短文化は前処理の主目的としない。本文は極力そのまま（正確な文字列・段落・見出し）として復元する。
2. **圧縮は参照化で実現**  
   トークン削減は「内容の捨象」ではなく、ID参照・重複の辞書化・目的別ビューのコンパイルによって行う。
3. **監査可能性（Provenance First）**  
   生成したMarkdown／リンクラベルは必ず原典PDFのページ・座標（bbox）へ遡及できること。
4. **目的非依存（レビュー一般への適用）**  
   特定のレビュー成果（例：因果モデルのみ）に最適化しすぎず、文意構造・引用・主張単位・関係をコアとして保持する。
5. **保守的な断定（誤分類を前提に確信度管理）**  
   前処理段階での意味解釈（引用機能、RQ判定等）は確率／確信度付きで保持し、断定しすぎない。
6. **拡張容易性（Layered Architecture）**  
   まずは構造復元＋基本リンクラベルをコアにし、主張関係グラフや主張趣旨評価など高度化はプラグインで拡張する。

---

## 2. 用語定義（Glossary）

- **原典（Source of Truth）**：入力PDF。監査時に参照される唯一の根拠媒体。
- **本文（Body Text）**：ヘッダー/フッター等のノイズを除去し、読み順を復元した論文テキスト。
- **ノイズ（Noise）**：ヘッダー、フッター、ページ番号、ランニングヘッド、DOIの繰り返し等、本文理解に不要な反復文字列。
- **sidecar**：本文テキストを改変せず、別ファイルで段落（行範囲/文ID/文字オフセット）に対してタグとリンクを付与する方式。
- **段落**：本文中の連続範囲。参照単位（mdの行番号範囲、文ID、文字オフセット等）。
- **段落位置**：段落が原典PDFのどの位置（ページ、bbox）に対応するかの情報。
- **文意**：背景、ギャップ、目的、RQ、仮説、方法、結果、解釈、含意、限界等、論証上の機能ラベル。
- **引用（Citation）**：本文中の引用表現（著者年式、番号式）と参考文献リストの対応。
- **引用機能（Citation Role）**：support/contrast/definition/method-borrowing/boundary-setting など、引用が果たす機能（確信度付き）。
- **主張単位（Claim Unit）**：論文中の最小主張（仮説、発見、解釈等）として抽出・参照される単位。
- **主張趣旨（Causal Status）**：因果“主張”／関連記述／同定された因果などの区別と、同定戦略・時間構造のメタ情報。

---

## 3. スコープ

### 3.1 対象
- 学術論文PDF（born-digital：テキスト層を含むPDF）を主対象とする。
- 画像スキャンPDF（OCR必須）はオプション扱い（Phase 2以降）とする。

### 3.2 非対象（Non-Goals）
- 前処理段階での全文要約生成（圧縮目的の要約）は行わない。
- 因果推論の同定（因果効果の推定）そのものは本システムの責務ではない（ただし同定戦略のメタ抽出は対象）。
- 図の内容を断定的に解釈する（キャプション・本文参照なしに図から推論する）処理は行わない。

---

## 4. 要求仕様

### 4.1 機能要件（Functional Requirements）

**FR-1 入力**  
- 入力はPDFファイル単体（ユーザーはPDFを投入するだけ）を最小操作とする。
- 入力PDFのメタデータ（ファイル名、ページ数、作成情報）が取得可能であること。

**FR-2 本文復元（ノイズ除去＋読み順復元）**  
- ヘッダー/フッター/ページ番号等の反復ノイズを除去する。
- 2段組等のレイアウトに対して、可能な限り自然な読み順（左→右、上→下）を復元する。
- 行末ハイフネーション等を可能な範囲で正規化する（可逆性を損なわない範囲で）。

**FR-3 構造付与（Markdown生成）**  
- 見出し階層（H1/H2/H3…）を推定しMarkdownへ反映する。
- セクション境界の推定（Introduction/Methods/Results/Discussion等）を付与できること（確信度付きで可）。
- 図表キャプション・図表番号を抽出し、本文に適切に配置する。
- 参考文献セクションを本文から分離する。

**FR-4 表の再現**  
- 表を機械可読（最低限：列構造を保持）で出力する。形式はMarkdown tableまたはCSV埋め込みを選択可能とする。
- 表抽出が不確実な場合、セル境界崩れを検出し「品質低」フラグを付与する。

**FR-5 sidecar（リンクラベル）生成**  
- Markdown内段落と原典PDF（ページ・bbox）を対応づける段落位置情報を必須で出力する。
- 以下のリンクラベルを少なくとも出力する（コア）  
  - 文意（Discourse Role）  
  - 引用抽出（in-text citation）および参考文献との対応  
  - 図表（Figure/Table）のID、キャプション段落  
  - 脚注ブロック（抽出できる場合）  
- 高度リンクラベルはプラグインとして拡張可能とする  
  - 引用機能（Citation Role）  
  - 主張単位（Claim Unit）  
  - 主張間関係（support/rebut/qualify）  
  - 主張趣旨（Causal Status）

**FR-6 図の補助記述（オプション）**  
- 図を自然言語で補助記述する場合、必ずキャプションおよび本文の図参照段落に紐づける。
- 図補助記述は断定を避け、確信度（low/medium/high）を持つこと。

**FR-7 品質ゲート（Quality Gates）**  
- 変換結果の自動検査を行い、合否と警告を出力する。  
  - 見出し階層の破綻検知  
  - 図表番号・キャプションの抽出率  
  - 参考文献分離の成否  
  - 引用抽出率（最低閾値）  
  - 表の列崩れ検知（行ごとのセル数分散等）

### 4.2 非機能要件（Non-Functional Requirements）

- **NFR-1 再現性**：同一入力から同一出力（または同一バージョンの決定的出力）が得られる。
- **NFR-2 監査性**：任意のリンクラベル・要素からPDF原典（page+bbox）へ遡れる。
- **NFR-3 可観測性**：ログにより、どの規則・モデル・ヒューリスティックが効いたか追跡可能。
- **NFR-4 拡張性**：リンクラベル種別の追加が、既存フォーマット破壊なしに可能（スキーマ拡張）。
- **NFR-5 安全性**：外部送信なしのローカル処理を基本とし、研究データの秘匿性を担保。

---

## 5. システム構成（アーキテクチャ）

### 5.1 全体構成（Layered Pipeline）

1. **Ingest**：PDF受領、メタデータ取得、ページ画像/テキスト層有無判定  
2. **Layout Extraction**：テキスト要素＋座標＋フォント特徴の抽出（ブロック/行/文字）  
3. **Denoising**：ヘッダー/フッター等の反復ノイズ除去  
4. **Reading Order Reconstruction**：列推定・ブロック単位の読み順復元  
5. **Structure Inference**：見出し階層、セクション、図表/参考文献/脚注の推定  
6. **Markdown Rendering**：本文・図表・参考文献をmdとして出力  
7. **Sidecar**：段落↔PDF参照、文意、引用対応、品質情報を出力  
8. **Quality Gates**：自動検査、レポート生成

### 5.2 コンポーネント責務
- **Renderer**：md出力（可読性重視・規則化）
- **Annotator**：リンクラベル出力（機械可読・参照可能性重視）
- **Inspector**：品質検査（閾値・警告・失敗理由の提示）

---

## 6. データ設計（出力フォーマット）

### 6.1 出力ファイル一覧
- `paper.md`：復元本文（見出し・図表キャプション・表・参考文献）  
- `paper.ann.jsonl`：リンクラベル（1行1レコード）  
- `paper.qc.json`：品質ゲート結果（集計・警告）  
- `paper.meta.json`：入力メタデータ、処理バージョン、処理時間、設定

### 6.2 Markdown設計原則
- 見出しは `#`〜`####` を使用（過剰な深さは避ける）
- 段落間は空行で分離
- 図表は以下を標準形とする  
  - `**Figure 2.** Caption...`  
  - `**Table 1.** Caption...`  
  - 表本体（Markdown tableまたはCSVブロック）
- 参考文献は `# References` セクションに分離
- 脚注は `# Footnotes`（抽出できた場合）に分離し、本文には参照記号のみ残す（可能なら）

### 6.3 リンクラベル（JSONL）スキーマ（コア）

#### 6.3.1 共通フィールド
- `id`：リンクラベルID（UUID推奨）
- `type`：リンクラベル種別（例：`span`, `heading`, `figure`, `table`, `citation`, `discourse` 等）
- `span`：本文段落参照（いずれか/併用）
  - `md_line_start`, `md_line_end`
  - `sentence_ids`（将来拡張）
  - `char_start`, `char_end`（任意）
- `pdf_ref`：原典参照（必須）
  - `page`（1-index）
  - `bbox`：`[x0,y0,x1,y1]`（ページ座標系定義はmetaに記載）
  - `text_hash`（任意：照合用）
- `confidence`：`0.0–1.0`（推定リンクラベルのみ。確定情報は1.0）

#### 6.3.2 文意リンクラベル（discourse）
- `type: "discourse"`
- `role`：`background | prior_work | gap | purpose | rq | hypothesis | method | result | interpretation | implication | limitation | contribution | appendix | other`
- `features`（任意）：セクション名推定、Cue phrase等

#### 6.3.3 引用リンクラベル（citation）
- `type: "citation"`
- `in_text`：本文の引用文字列（例：`(Smith & Lewis, 2011)` / `[12]`）
- `style`：`author_year | numeric | mixed`
- `ref_key`：参考文献側キー（可能なら）
- `ref_entry_span`：参考文献側の段落参照（md_line範囲）
- `citation_role`（任意・推定）：`support | contrast | definition | method_borrowing | boundary_setting | other`
- `confidence`：推定時必須

#### 6.3.4 図表リンクラベル（figure/table）
- `type: "figure"` または `"table"`
- `label`：`Figure 2` / `Table 1`
- `caption_span`：キャプションのmd段落
- `body_span`：図表本体のmd段落（表の場合）
- `quality`：`high | medium | low`（抽出信頼度）

### 6.4 品質ゲート出力（QC）
- `overall_status`：`pass | pass_with_warnings | fail`
- 指標例：
  - `heading_consistency`（階層飛び検出）
  - `citation_extraction_rate`（引用抽出数/期待）
  - `references_detected`（References分離の成否）
  - `figure_table_coverage`（番号・キャプション抽出数）
  - `table_integrity_score`（セル数分散等）
- `warnings[]`：コード＋説明＋該当段落（md/pd_ref）

---

## 7. 処理設計（主要アルゴリズム・ヒューリスティック）

### 7.1 ヘッダー／フッター除去（Denoising）
- 各ページ上端・下端領域（y座標閾値）に出現する行を収集
- 文字列正規化（空白・ハイフン・数字マスク等）を行った上で頻度集計
- **一定割合以上のページで反復**する行をノイズ候補とし除去  
- ただし以下は保護規則を適用  
  - フォントが見出し候補（大きい/太字）  
  - セクション開始直後ページの短い見出し文字列  
  - 図表キャプション様式（Figure/Table）  
- 除去は「完全削除」ではなく、**除去リンクラベル**として残す（監査用）

### 7.2 読み順復元（Reading Order）
- ブロック（段落候補）単位で扱う（行単位は混線が増えるため）
- x座標分布から列クラスタを推定（例：k-means/ヒューリスティック）
- 各列内はy昇順で並べ、列はx昇順で並べる  
- 図回り込み（wrap）を検出した場合は、近傍ブロックの重なりで順序を調整  
- 不確実な場合は、`order_confidence` をリンクラベルに記録し、QCで警告

### 7.3 見出し判定（Structure Inference）
- フォントサイズ、太字、前後空白、番号パターン（`1.`, `1.1`）を特徴量として見出し候補抽出
- 章節階層は、フォントサイズの段階差＋番号体系の整合で決定
- 誤判定リスクが高い箇所（短い文・ページ先頭のみ等）には確信度を付与

### 7.4 参考文献分離（References）
- `References` / `Bibliography` 等の見出し候補から開始点推定
- 以降の段落が「引用エントリ形（著者・年・ジャーナル等）」で高密度ならReferences確信度を上げる
- 参考文献セクションは本文から分離し、md上は独立セクションへ移動（移動リンクラベルを残す）

### 7.5 引用抽出（In-text Citation Parsing）
- 著者年式：`(Author, 20xx)` / `Author (20xx)` / 複数年・複数著者のパターンを許容
- 番号式：`[12]` / `^12` 等を許容（設定で切替）
- 抽出結果は reference list のエントリと照合し `ref_key` を付与（不一致は未確定として残す）

### 7.6 表抽出（Table Reconstruction）
- 表領域検出（キャプション近傍、罫線、列整列等）
- 行・列の推定を行い、セル数の安定性を `table_integrity_score` として算出
- スコアが低い場合は、表本体を「テキスト＋区切り」形式で残し、QCで警告（誤った表に整形して捏造しない）

### 7.7 図の補助記述（Optional）
- キャプションと本文の図参照文（`Figure X shows...`）を抽出して根拠段落化
- 補助記述は「観察」レベルに留め、確信度を必須付与

---

## 8. 機能拡張（プラグイン設計）

### 8.1 拡張対象
- **文意の高精度化**（導入部のCARSムーブ等）
- **引用機能（citation_role）推定**（support/contrast等）
- **主張単位抽出（Claim Units）**
- **主張間関係グラフ**（support/rebut/qualify）
- **主張趣旨（Causal Status）**
  - causal_claim / associational / interpretive  
  - identification: experimental/quasi/longitudinal/cross-sectional 等（推定）

### 8.2 拡張の原則
- 本文（md）を改変しない。sidecarへの追記のみ。
- 推定には必ず `confidence` を付与し、根拠段落（段落位置）を保持する。
- 誤りが致命的になる断定（例：因果同定の確定）は行わない。

---

## 9. 例外処理・ログ・デバッグ

### 9.1 例外分類
- `E_INPUT_CORRUPT`：PDF破損
- `E_NO_TEXT_LAYER`：テキスト層なし（OCR必要）
- `E_LAYOUT_UNSTABLE`：列推定不安定
- `E_TABLE_LOW_CONF`：表復元低信頼
- `E_REFERENCE_NOT_FOUND`：参考文献検出失敗

### 9.2 ログ要件
- 入力PDFメタ（ページ数、抽出方式）
- 除去されたノイズ候補一覧（文字列正規化後の代表）
- 読み順復元の列数、クラスタ中心、例外ページ
- 見出し推定の規則適用状況
- QC結果と該当段落参照

---

## 10. 受入基準（Acceptance Criteria）

### 10.1 必須合格条件（Phase 1）
- PDF→md変換で本文が段落単位で追えること（2段組混線が限定的）
- Referencesが独立セクションとして分離されること（失敗時は明確にfail）
- 図表キャプションが検出され、md上に残ること（一定率以上）
- sidecarに段落↔PDF参照が付与され、任意段落から原典に遡れること
- QCが `pass_with_warnings` 以上であること（failが多発しない）

### 10.2 推奨条件（Phase 2）
- 引用抽出とreference照合の成功率が一定閾値以上
- 表の完全復元率（高品質表について）が一定以上
- 文意推定の精度が導入部で実用水準

---

## 11. 実装メモ（既存のPDF→md変換プログラムとの整合）

本設計は、既に開発中の「PDF→md変換」をコアに据え、以下を追加・強化する形で整合する。

- md生成は維持しつつ、**sidecar（リンクラベル・段落位置・QC）を追加**する
- 既存のノイズ除去ロジックは、除去結果をリンクラベルとして出力する（監査性）
- 図の言語化は「補助記述」としてリンクラベル化し、必ず根拠段落に紐づける

---

## 12. 今後の決定事項（仕様確定に必要なパラメータ）
本書は目的非依存で設計しているが、実装の固定には以下を確定するとよい。

1. **座標系の定義**（bboxの原点、単位、回転ページの扱い）
2. **段落参照単位**（md行番号を正とするか、文ID＋文字オフセットを正とするか）
3. **表の出力形式**（md table優先か、CSV優先か、混在許可か）
4. **引用様式の優先**（著者年式中心か、番号式も標準対応か）
5. **OCR対応のフェーズ**（Phase 2以降とするか、最初から含めるか）

---

# 付録A：リンクラベルJSONL 最小レコード例（参考）

※ここでは“例”として示す（実装ではUUID・座標系・行番号整合が必須）。

```json
{"id":"a1","type":"discourse","role":"rq","span":{"md_line_start":120,"md_line_end":123},"pdf_ref":[{"page":3,"bbox":[72,120,520,180]}],"confidence":0.78}
{"id":"a2","type":"citation","in_text":"(Smith & Lewis, 2011)","style":"author_year","ref_key":"smith2011","span":{"md_line_start":98,"md_line_end":98},"pdf_ref":[{"page":2,"bbox":[310,410,420,430]}],"confidence":0.95}
{"id":"a3","type":"figure","label":"Figure 2","caption_span":{"md_line_start":210,"md_line_end":211},"span":{"md_line_start":210,"md_line_end":211},"pdf_ref":[{"page":6,"bbox":[70,640,520,720]}],"quality":"high","confidence":0.9}
```
